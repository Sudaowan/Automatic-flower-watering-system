#include <ESP8266WiFi.h>
#include <WiFiClient.h>



//巴法云服务器地址默认即可
#define TCP_SERVER_ADDR "bemfa.com"
//服务器端口，tcp创客云端口8344
#define TCP_SERVER_PORT "8344"

//********************需要修改的部分*******************//

#define DEFAULT_STASSID  "swsys"     //WIFI名称，区分大小写，不要写错
#define DEFAULT_STAPSW   "1111177777"  //WIFI密码
String UID = "bb836c32bb644aa81ea37aa18794cfdb";  //用户私钥，可在控制台获取,修改为自己的UID
String TOPIC =   "1";         //主题名字，可在控制台新建
String TOPIC2 =   "wd";


//**************************************************//



//最大字节数
#define MAX_PACKETSIZE 512
//设置心跳值30s
#define KEEPALIVEATIME 30*1000



//tcp客户端相关初始化，默认即可
WiFiClient TCPclient;
String TcpClient_Buff = "";
unsigned int TcpClient_BuffIndex = 0;
unsigned long TcpClient_preTick = 0;
unsigned long preHeartTick = 0;//心跳
unsigned long preTCPStartTick = 0;//连接
bool preTCPConnected = false;



//相关函数初始化
//连接WIFI
void doWiFiTick();
void startSTA();

//TCP初始化连接
void doTCPClientTick();
void startTCPClient();
void sendtoTCPServer(String p);

//设变量 控制函数

void turnOffLed();
volatile int item;
volatile int HPL;
volatile int LL;
volatile int WWW;
volatile int my_2;
#define upDataTime 2*1000


/*
   发送数据到TCP服务器
*/
void sendtoTCPServer(String p) {

  if (!TCPclient.connected())
  {
    Serial.println("Client is not readly");
    return;
  }
  TCPclient.print(p);
  Serial.println("[Send to TCPServer]:String");
  Serial.println(p);
}


/*
   初始化和服务器建立连接
*/
void startTCPClient() {
  if (TCPclient.connect(TCP_SERVER_ADDR, atoi(TCP_SERVER_PORT))) {
    Serial.print("\nConnected to server:");
    Serial.printf("%s:%d\r\n", TCP_SERVER_ADDR, atoi(TCP_SERVER_PORT));

    String tcpTemp = ""; //初始化字符串
    tcpTemp = "cmd=1&uid=" + UID + "&topic=" + TOPIC + "\r\n"; //构建订阅指令
    sendtoTCPServer(tcpTemp); //发送订阅指令
    tcpTemp = ""; //清空

    preTCPConnected = true;
    preHeartTick = millis();
    TCPclient.setNoDelay(true);
  }
  else {
    Serial.print("Failed connected to server:");
    Serial.println(TCP_SERVER_ADDR);
    TCPclient.stop();
    preTCPConnected = false;
  }
  preTCPStartTick = millis();
}


/*
   检查数据，发送心跳
*/
void doTCPClientTick() {
  //检查是否断开，断开后重连
  if (WiFi.status() != WL_CONNECTED) return;

  if (!TCPclient.connected()) {//断开重连

    if (preTCPConnected == true) {

      preTCPConnected = false;
      preTCPStartTick = millis();
      Serial.println();
      Serial.println("TCP Client disconnected.");
      TCPclient.stop();
    }
    else if (millis() - preTCPStartTick > 1 * 1000) //重新连接
      startTCPClient();
  }
  else
  {
    if (TCPclient.available()) {//收数据
      char c = TCPclient.read();
      TcpClient_Buff += c;
      TcpClient_BuffIndex++;
      TcpClient_preTick = millis();

      if (TcpClient_BuffIndex >= MAX_PACKETSIZE - 1) {
        TcpClient_BuffIndex = MAX_PACKETSIZE - 2;
        TcpClient_preTick = TcpClient_preTick - 200;
      }
      preHeartTick = millis();
    }
    if (millis() - preHeartTick >= KEEPALIVEATIME) { //保持心跳
      preHeartTick = millis();
      Serial.println("--Keep alive:");
      sendtoTCPServer("cmd=0&msg=keep\r\n");
    }
    if (millis() - preHeartTick >= upDataTime) { //上传数据
      preHeartTick = millis();

      /*****************获取湿度*****************/
      WWW = analogRead(A0);
      Serial.println(WWW);
      /*********************数据上传*******************/
      /*
        数据用#号包裹，以便app分割出来数据，&msg=#23#80#on#\r\n，即#温度#湿度#按钮状态#，app端会根据#号分割字符串进行取值，以便显示
        如果上传的数据不止温湿度，可在#号后面继续添加&msg=#23#80#data1#data2#data3#data4#\r\n,app字符串分割的时候，要根据上传的数据进行分割
      */
      String upstr = "";
      upstr = "cmd=2&uid=" + UID + "&topic=" + TOPIC2 + "&msg=#" + WWW + "#\r\n";
      sendtoTCPServer(upstr);
      upstr = "";
    }
  }
  if ((TcpClient_Buff.length() >= 1) && (millis() - TcpClient_preTick >= 200))
  { //data ready
    TCPclient.flush();
    Serial.println("Buff");
    Serial.println(TcpClient_Buff);
    if ((TcpClient_Buff.indexOf("&msg=HPL") > 0)) {
      HPL = 1;
      LL = 0;
    } else if ((TcpClient_Buff.indexOf("&msg=LL") > 0)) {
      HPL = 0;
      LL = 1;
    } else if ((TcpClient_Buff.indexOf("&msg=off") > 0)) {
      turnOffLed();     //执行函数
      HPL = 0;
      LL = 0;
      TcpClient_Buff = ""; //清空字符串，以便下次接收
      TcpClient_BuffIndex = 0;
    }
  }
}



void startSTA()
{
  WiFi.disconnect();
  WiFi.mode(WIFI_STA);
  WiFi.begin(DEFAULT_STASSID, DEFAULT_STAPSW);
}



/**************************************************************************
                                 WIFI
***************************************************************************/
/*
  WiFiTick
  检查是否需要初始化WiFi
  检查WiFi是否连接上，若连接成功启动TCP Client
  控制指示灯
*/
void doWiFiTick()
{
  static bool startSTAFlag = false;
  static bool taskStarted = false;
  static uint32_t lastWiFiCheckTick = 0;
  if (!startSTAFlag)
  {
    startSTAFlag = true;
    startSTA();
    Serial.printf("Heap size:%d\r\n", ESP.getFreeHeap());
  }
  //未连接1s重连
  if ( WiFi.status() != WL_CONNECTED )
  {
    if (millis() - lastWiFiCheckTick > 1000) {
      lastWiFiCheckTick = millis();
    }
  }
  //连接成功建立
  else
  {
    if (taskStarted == false)
    {
      taskStarted = true;
      Serial.print("\r\nGet IP Address: ");
      Serial.println(WiFi.localIP());
      startTCPClient();
    }
  }

}
void turnOffLed() {
  digitalWrite(D0, HIGH);
  digitalWrite(D1, HIGH);
  digitalWrite(D2, HIGH);
  digitalWrite(D3, HIGH);
  digitalWrite(D4, HIGH);
  digitalWrite(D5, HIGH);
  digitalWrite(D6, HIGH);
  digitalWrite(D7, HIGH); //关闭该程序，停止检测，停止水泵
}

void loop()
{
  if (HPL == 1)
  {
    item = 300;
    digitalWrite(D1, LOW);
    digitalWrite(D2, HIGH);
    digitalWrite(D3, HIGH);
    digitalWrite(D4, HIGH);
    if (analogRead(A0) > item)
    {
      digitalWrite(D0, LOW);
      delay(2000);
      digitalWrite(D0, HIGH);
      delay(5000);
    }
    delay(1000);
    digitalWrite(D1, HIGH);
    digitalWrite(D2, LOW);
    digitalWrite(D3, HIGH);
    digitalWrite(D4, HIGH);
    if (analogRead(A0) > item)
    {
      digitalWrite(D5, LOW);
      delay(2000);
      digitalWrite(D5, HIGH);
      delay(5000);
    }
    delay(1000);
    digitalWrite(D1, HIGH);
    digitalWrite(D2, HIGH);
    digitalWrite(D3, LOW);
    digitalWrite(D4, HIGH);
    if (analogRead(A0) > item)
    {
      digitalWrite(D6, LOW);
      delay(2000);
      digitalWrite(D6, HIGH);
      delay(5000);
    }
    delay(1000);
    digitalWrite(D1, HIGH);
    digitalWrite(D2, HIGH);
    digitalWrite(D3, HIGH);
    digitalWrite(D4, LOW);
    if (analogRead(A0) > item)
    {
      digitalWrite(D7, LOW);
      delay(2000);
      digitalWrite(D7, HIGH);
      delay(5000);
    }
    delay(1000);
  }
  if (LL == 1)
  {
    item = 250;
    digitalWrite(D1, LOW);
    digitalWrite(D2, HIGH);
    digitalWrite(D3, HIGH);
    digitalWrite(D4, HIGH);
    if (analogRead(A0) > item)
    {
      digitalWrite(D0, LOW);
      delay(2000);
      digitalWrite(D0, HIGH);
      delay(5000);
    }
    delay(1000);
    digitalWrite(D1, HIGH);
    digitalWrite(D2, LOW);
    digitalWrite(D3, HIGH);
    digitalWrite(D4, HIGH);
    if (analogRead(A0) > item)
    {
      digitalWrite(D5, LOW);
      delay(2000);
      digitalWrite(D5, HIGH);
      delay(5000);
    }
    delay(1000);
    digitalWrite(D1, HIGH);
    digitalWrite(D2, HIGH);
    digitalWrite(D3, LOW);
    digitalWrite(D4, HIGH);
    if (analogRead(A0) > item)
    {
      digitalWrite(D6, LOW);
      delay(2000);
      digitalWrite(D6, HIGH);
      delay(5000);
    }
    delay(1000);
    digitalWrite(D1, HIGH);
    digitalWrite(D2, HIGH);
    digitalWrite(D3, HIGH);
    digitalWrite(D4, LOW);
    if (analogRead(A0) > item)
    {
      digitalWrite(D7, LOW);
      delay(2000);
      digitalWrite(D7, HIGH);
      delay(5000);
    }
    delay(1000);
  }
  doWiFiTick();
  doTCPClientTick();
}


void setup() {
  Serial.begin(9600);
  pinMode(D0, OUTPUT);
  pinMode(D1, OUTPUT);
  pinMode(D2, OUTPUT);
  pinMode(D3, OUTPUT);
  pinMode(D4, OUTPUT);
  pinMode(D5, OUTPUT);
  pinMode(D6, OUTPUT);
  pinMode(D7, OUTPUT);
  digitalWrite(D0, HIGH);
  digitalWrite(D1, HIGH);
  digitalWrite(D2, HIGH);
  digitalWrite(D3, HIGH); //开机时全部关闭检测，等待开始检测
  digitalWrite(D4, HIGH);
  digitalWrite(D5, HIGH);
  digitalWrite(D6, HIGH);
  digitalWrite(D7, HIGH); //水泵全部停止工作
  delay(1000);
  item = 0;
}
